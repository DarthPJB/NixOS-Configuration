# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, self, modulesPath, ... }:

{
  imports =
    [
      # Include the results of the hardware scan.
      ./hardware-configuration.nix
      ../../environments/steam.nix
    ];
  # Use the GRUB 2 boot loader.
  # Use the systemd-boot EFI boot loader.
  boot.loader =
    {
      systemd-boot.enable = true;
      efi.canTouchEfiVariables = true;
    };
  systemd.user.services.browser =
    {
      enable = true;
      description = "browser-autostart";
      wantedBy = [ "graphical-session.target" ];
      serviceConfig =
        {
          Restart = "always";
          ExecStart = ''
            ${lib.getExe self.un_pkgs.firefox}
          '';
          PassEnvironment = "DISPLAY XAUTHORITY";
        };
    };
  # The global useDHCP flag is deprecated, therefore explicitly set to false here.
  # Per-interface useDHCP will be mandatory in the future, so this generated config
  # replicates the default behaviour.


  networking.firewall.allowedTCPPorts = [ 53 ];
  # Set a static IP on the "downstream" interface
  networking.firewall.extraCommands = ''
    # Set up SNAT on packets going from downstream to the wider internet
    iptables -t nat -A POSTROUTING -o wlp3s0 -j MASQUERADE

    # Accept all connections from downstream. May not be necessary
    iptables -A INPUT -i enp0s25 -j ACCEPT
  '';
  # Run a DHCP server on the downstream interface
  services.kea.dhcp4 = {
    enable = true;
    settings = {
      interfaces-config = {
        interfaces = [
          "enp0s25"
        ];
      };
      lease-database = {
        name = "/var/lib/kea/dhcp4.leases";
        persist = true;
        type = "memfile";
      };
      rebind-timer = 2000;
      renew-timer = 1000;
      subnet4 = [
        {
          id = 1;
          pools = [
            {
              pool = "10.0.0.2 - 10.0.0.255";
            }
          ];
          subnet = "10.0.0.1/24";
        }
      ];
      valid-lifetime = 4000;
      option-data = [{
        name = "routers";
        data = "10.0.0.1";
      }];
    };
  };



  networking =
    {
      useDHCP = false;
      hostName = "Terminal-zero"; # Define your hostname.
      interfaces =
        {
          "enp0s25" = {
            useDHCP = false;
            ipv4.addresses = [{
              address = "10.0.0.1";
              prefixLength = 24;
            }];
          };
          wlp3s0.useDHCP = true;
          wwp0s29u1u4i6.useDHCP = true;
        };
      wireless =
        {
          enable = true; # Enables wireless support via wpa_supplicant.
          userControlled.enable = true;
          interfaces = [ "wlp3s0" "wwp0s29u1u4i6" ];
        };
    };

  # Enable CUPS to print documents.
  # Enable touchpad support (enabled default in most desktopManager).
  services =
    {
      libinput.enable = true;
      printing.enable = true;
    };

  # Enable sound.

  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true;
  };
  hardware.graphics = {
    enable = true;
    extraPackages = with pkgs; [
      intel-media-driver
      vaapiVdpau
      libvdpau-va-gl
    ];
  };

}
