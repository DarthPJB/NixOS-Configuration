# NixOS Infrastructure Refactoring Plan\n\n## Executive Summary\n\n**Status:** Initialized - Phase 0 (Planning)\n**Branch:** AI/Overlord (locked)\n**Objective:** Transform legacy monolithic NixOS configurations into modular, scalable architecture\n\n### Current Architecture Assessment\n- ✅ 17 production NixOS hosts operational\n- ✅ Nixinate deployment pipeline functional\n- ✅ Secrix secrets management active\n- ⚠️ Monolithic machine configs, scattered environments\n\n### High-Level Refactoring Strategy\n```\nPhase 1: Audit & Baseline (Q1)\n├── Host inventory & dependency mapping\n├── Critical path identification\n└── Risk assessment\n\nPhase 2: Modularization (Q2)\n├── Environment → Feature modules\n├── Machine → Composition patterns\n└── Shared lib extraction\n\nPhase 3: Deployment Pipeline (Q3)\n├── CI/CD automation\n├── Blue-green deployment\n└── Rollback procedures\n\nPhase 4: Validation & Migration (Q4)\n├── Parallel validation\n├── Staged rollout\n└── Documentation freeze\n```\n\n### Immediate Priorities\n1. **Risk Mitigation:** Local builds/tests before any changes\n2. **Change Isolation:** Single-host validation per iteration\n3. **Rollback Safety:** Git bisect + nix flake pins\n\n**Next Action:** Phase 1 host inventory\n\n---\n\n## LLM Session Instructions (Machine-Readable)\n\n### Core Protocol\n```yaml\nworkflow:\n  intent_discernment: sigint_pattern_matching\n  planning: always_update_root/REFATORING_PLAN.md\n  constraint: current_branch_only\n  validation: [nix_flake_check, local_build, vm_test]\n  commit_protocol: descriptive_messages + pre_commit_hooks\n```\n\n### Planning Document Structure\n1. **Executive Summary** (human-readable, 1-page max)\n   - Status/Progress\n   - Architecture assessment\n   - Strategy overview\n   - Immediate priorities\n2. **LLM Instructions** (machine-executable)\n   - Protocol definitions\n   - Phase breakdowns\n   - Task templates\n   - Validation checklists\n\n### Phase Templates\n```nix\n# Phase X: [Name]\npriorities:\n  - task1: { files: [], validation: [], dependencies: [] }\n  - task2: { files: [], validation: [], dependencies: [task1] }\nchecklist:\n  - [ ] flake check\n  - [ ] nixos-rebuild build --flake .#[host]\n  - [ ] nixos-rebuild build-vm --flake .#[host]\n  - [ ] nix run .#[host] (test deploy)\n```\n\n### Task Execution Pattern\n1. Update planning doc → Mark in_progress\n2. Execute single concern → Minimal file delta\n3. Validate → flake check + build + test\n4. Commit → Descriptive message\n5. Update planning doc → Mark completed\n6. Report status\n\n### Agent Delegation\n```yaml\nexplore: codebase_discovery(quick/medium/thorough)\nbuild: implementation + testing (this agent)\nTPol: validation + risk analysis\ntask explore: discovery_needed\n```\n\n### Safety Protocols\n- NEVER: direct nixpkgs_unstable access\n- NEVER: commit unencrypted secrets\n- ALWAYS: test_mode_deployments_first\n- FAILSAFE: git_status + git_diff before commits\n```\n\n**Document initialized. Ready for Phase 1 directive.**